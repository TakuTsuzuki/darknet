#include <stdio.h>
#include "mlp.h"
#include "network.h"
#include "list.h"
#include "option_list.h"
#include "parser.h"
#include "image.h"
#include "data.h"

#define IRIS_DATA_SIZE 12

/* modified train_classifier @ examples/classifier.c */
network **make_mlp_network()
{
    int ngpus = 1;
    network **nets = calloc(ngpus, sizeof(network*));

    list *sections = make_cfg();
    nets[0] = make_mlp_single_network(sections);

    network *net = nets[0];

    list *options = make_data_cfg();
    // int tag = option_find_int_quiet(options, "tag", 0);
    // char *label_list = option_find_str(options, "labels", "data/labels.list");
    // char *train_list = option_find_str(options, "train", "data/train.list");
    char *tree = option_find_str(options, "tree", 0);
    if (tree) net->hierarchy = read_tree(tree);
    // int classes = option_find_int(options, "classes", 2);
    free_list(options);
    options = NULL;

    return nets;
}

int NUM_NETWORK_CFG_TYPES = 5;
char NETWORK_CFG_TYPES[5][16] = {
        "[net]",
        "[connected]",
        "[dropout]",
        "[connected]",
        "[softmax]"
};
int NUM_NETWORK_NET_CFG[5] = {16, 18, 19, 21, 22};
char NETWORK_NET_CFG[][2][64] = {
        // [net]
        // {"batch", "64"},
        // {"batch", "8"},
        {"batch", "1"},
        {"subdivisions", "1"},
        // {"height", "28"},
        // {"width", "28"},
        {"height", "4"},
        {"width", "4"},
        {"channels", "3"},
        // {"max_crop", "32"},
        // {"min_crop", "32"},
        {"max_crop", "4"},
        {"min_crop", "4"},
        {"hue", ".1"},
        {"saturation", ".75"},
        {"exposure", ".75"},
        {"learning_rate", "0.1"},
        {"policy", "poly"},
        {"power", "4"},
        // {"max_batches", "5000"},
        {"max_batches", "100"},
        {"momentum", "0.9"},
        {"decay", "0.0005"},

        // [connected]
        // {"output", "784"},
        {"output", "10"},
        {"activation", "relu"},

        // [dropout]
        {"probability", ".5"},

        // [connected]
        // {"output", "10"},
        {"output", "3"},
        {"activation", "linear"},

        // [softmax]
        {"groups", "1"}
};

/* char LABELS[3][20] = {"Iris-virginica", "Iris-versicolor", "Iris-setosa"}; */

list *make_cfg()
{
    list *options = make_list();
    section *current = NULL;
    int i = 0;
    int j = 0;
    for (i = 0; i < NUM_NETWORK_CFG_TYPES; i++) {
        current = malloc(sizeof(section));
        current->type = NETWORK_CFG_TYPES[i];
        current->options = make_list();
        for (; j < NUM_NETWORK_NET_CFG[i]; j++) {
            option_insert(current->options, NETWORK_NET_CFG[j][0], NETWORK_NET_CFG[j][1]);
        }
        list_insert(options, current);
    }

    return options;
}

char DATA_CFG[][2][64] = {
        {"classes", "3"},
        {"train", "train_path"},
        {"valid", "test_path"},
        {"labels", "label_path"},
        {"backup", "backup_path"},
        {"top", "2"}
};
int NUM_DATA_CFG = 6;

list *make_data_cfg()
{
    list *options = make_list();
    int i;
    for (i = 0; i < NUM_DATA_CFG; i++) {
        option_insert(options, DATA_CFG[i][0], DATA_CFG[i][1]);
    }
    return options;
}

float IRIS_DATA[][IRIS_DATA_SIZE] = {
{127.49999999999999, 87.5, 35.0, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{122.50000000000001, 75.0, 35.0, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{117.5, 80.0, 32.5, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{114.99999999999999, 77.5, 37.5, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{125.0, 90.0, 35.0, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{135.0, 97.5, 42.5, 10.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{114.99999999999999, 85.0, 35.0, 7.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{125.0, 85.0, 37.5, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{110.00000000000001, 72.5, 35.0, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{122.50000000000001, 77.5, 37.5, 2.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{135.0, 92.5, 37.5, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{120.0, 85.0, 40.0, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{120.0, 75.0, 35.0, 2.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{107.5, 75.0, 27.500000000000004, 2.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{145.0, 100.0, 30.0, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{142.5, 110.00000000000001, 37.5, 10.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{135.0, 97.5, 32.5, 10.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{127.49999999999999, 87.5, 35.0, 7.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{142.5, 95.0, 42.5, 7.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{127.49999999999999, 95.0, 37.5, 7.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{135.0, 85.0, 42.5, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{127.49999999999999, 92.5, 37.5, 10.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{114.99999999999999, 90.0, 25.0, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{127.49999999999999, 82.5, 42.5, 12.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{120.0, 85.0, 47.5, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{125.0, 75.0, 40.0, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{125.0, 85.0, 40.0, 10.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{130.0, 87.5, 37.5, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{130.0, 85.0, 35.0, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{117.5, 80.0, 40.0, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{120.0, 77.5, 40.0, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{135.0, 85.0, 37.5, 10.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{130.0, 102.49999999999999, 37.5, 2.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{137.5, 105.0, 35.0, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{122.50000000000001, 77.5, 37.5, 2.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{125.0, 80.0, 30.0, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{137.5, 87.5, 32.5, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{122.50000000000001, 77.5, 37.5, 2.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{110.00000000000001, 75.0, 32.5, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{127.49999999999999, 85.0, 37.5, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{125.0, 87.5, 32.5, 7.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{112.5, 57.49999999999999, 32.5, 7.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{110.00000000000001, 80.0, 32.5, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{125.0, 87.5, 40.0, 15.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{127.49999999999999, 95.0, 47.5, 10.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{120.0, 75.0, 35.0, 7.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{127.49999999999999, 95.0, 40.0, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{114.99999999999999, 80.0, 35.0, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{132.5, 92.5, 37.5, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{125.0, 82.5, 35.0, 5.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{175.0, 80.0, 117.5, 35.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{160.0, 80.0, 112.5, 37.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{172.5, 77.5, 122.50000000000001, 37.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{137.5, 57.49999999999999, 100.0, 32.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{162.5, 70.0, 114.99999999999999, 37.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{142.5, 70.0, 112.5, 32.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{157.5, 82.5, 117.5, 40.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{122.50000000000001, 60.0, 82.5, 25.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{165.0, 72.5, 114.99999999999999, 32.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{130.0, 67.5, 97.5, 35.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{125.0, 50.0, 87.5, 25.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{147.5, 75.0, 105.0, 37.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{150.0, 55.00000000000001, 100.0, 25.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{152.5, 72.5, 117.5, 35.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{140.0, 72.5, 90.0, 32.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{167.5, 77.5, 110.00000000000001, 35.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{140.0, 75.0, 112.5, 37.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{145.0, 67.5, 102.49999999999999, 25.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{155.0, 55.00000000000001, 112.5, 37.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{140.0, 62.5, 97.5, 27.500000000000004, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{147.5, 80.0, 120.0, 45.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{152.5, 70.0, 100.0, 32.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{157.5, 62.5, 122.50000000000001, 37.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{152.5, 70.0, 117.5, 30.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{160.0, 72.5, 107.5, 32.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{165.0, 75.0, 110.00000000000001, 35.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{170.0, 70.0, 120.0, 35.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{167.5, 75.0, 125.0, 42.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{150.0, 72.5, 112.5, 37.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{142.5, 65.0, 87.5, 25.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{137.5, 60.0, 95.0, 27.500000000000004, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{137.5, 60.0, 92.5, 25.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{145.0, 67.5, 97.5, 30.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{150.0, 67.5, 127.49999999999999, 40.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{135.0, 75.0, 112.5, 37.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{150.0, 85.0, 112.5, 40.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{167.5, 77.5, 117.5, 37.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{157.5, 57.49999999999999, 110.00000000000001, 32.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{140.0, 75.0, 102.49999999999999, 32.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{137.5, 62.5, 100.0, 32.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{137.5, 65.0, 110.00000000000001, 30.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{152.5, 75.0, 114.99999999999999, 35.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{145.0, 65.0, 100.0, 30.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{125.0, 57.49999999999999, 82.5, 25.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{140.0, 67.5, 105.0, 32.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{142.5, 75.0, 105.0, 30.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{142.5, 72.5, 105.0, 32.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{155.0, 72.5, 107.5, 32.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{127.49999999999999, 62.5, 75.0, 27.500000000000004, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{142.5, 70.0, 102.49999999999999, 32.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{157.5, 82.5, 150.0, 62.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{145.0, 67.5, 127.49999999999999, 47.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{177.5, 75.0, 147.5, 52.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{157.5, 72.5, 140.0, 45.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{162.5, 75.0, 145.0, 55.00000000000001, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{190.0, 75.0, 165.0, 52.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{122.50000000000001, 62.5, 112.5, 42.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{182.5, 72.5, 157.5, 45.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{167.5, 62.5, 145.0, 45.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{180.0, 90.0, 152.5, 62.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{162.5, 80.0, 127.49999999999999, 50.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{160.0, 67.5, 132.5, 47.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{170.0, 75.0, 137.5, 52.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{142.5, 62.5, 125.0, 50.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{145.0, 70.0, 127.49999999999999, 60.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{160.0, 80.0, 132.5, 57.49999999999999, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{162.5, 75.0, 137.5, 45.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{192.5, 95.0, 167.5, 55.00000000000001, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{192.5, 65.0, 172.5, 57.49999999999999, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{150.0, 55.00000000000001, 125.0, 37.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{172.5, 80.0, 142.5, 57.49999999999999, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{140.0, 70.0, 122.50000000000001, 50.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{192.5, 70.0, 167.5, 50.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{157.5, 67.5, 122.50000000000001, 45.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{167.5, 82.5, 142.5, 52.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{180.0, 80.0, 150.0, 45.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{155.0, 70.0, 120.0, 45.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{152.5, 75.0, 122.50000000000001, 45.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{160.0, 70.0, 140.0, 52.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{180.0, 75.0, 145.0, 40.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{185.0, 70.0, 152.5, 47.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{197.5, 95.0, 160.0, 50.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{160.0, 70.0, 140.0, 55.00000000000001, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{157.5, 70.0, 127.49999999999999, 37.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{152.5, 65.0, 140.0, 35.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{192.5, 75.0, 152.5, 57.49999999999999, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{157.5, 85.0, 140.0, 60.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{160.0, 77.5, 137.5, 45.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{150.0, 75.0, 120.0, 45.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{172.5, 77.5, 135.0, 52.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{167.5, 77.5, 140.0, 60.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{172.5, 77.5, 127.49999999999999, 57.49999999999999, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{145.0, 67.5, 127.49999999999999, 47.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{170.0, 80.0, 147.5, 57.49999999999999, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{167.5, 82.5, 142.5, 62.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{167.5, 75.0, 130.0, 57.49999999999999, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{157.5, 62.5, 125.0, 47.5, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{162.5, 75.0, 130.0, 50.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{155.0, 85.0, 135.0, 57.49999999999999, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0},
{147.5, 75.0, 127.49999999999999, 45.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0}
};
int IRIS_DATA_LABELS[] = {
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
        2, 2, 2, 2, 2, 2, 2, 2, 2, 2
};
int NUM_IRIS_DATA = 150;

image load_iris_image(float *iris_datum, int size)
{
    image im = make_image(4, 1, 3);
    int i = 0;
    for (i = 0; i < IRIS_DATA_SIZE; i++) {
        im.data[i] = iris_datum[i];
    }
    return im;
}

matrix load_iris_images(int *indices, int n, int min, int max, int size, float angle, float aspect, float hue, float saturation, float exposure, int center)
{
    int i;
    matrix X;
    X.rows = n;
    X.vals = calloc(X.rows, sizeof(float*));
    X.cols = 0;

    for(i = 0; i < n; ++i){
        int index = indices[i];
        image im = load_iris_image(IRIS_DATA[index], IRIS_DATA_SIZE);
        image crop;
        if(center) {
            crop = center_crop_image(im, size, size);
        } else {
            crop = random_augment_image(im, angle, aspect, min, max, size, size);
        }
        int flip = rand()%2;
        if (flip) flip_image(crop);
        random_distort_image(crop, hue, saturation, exposure);

        /*
        show_image(im, "orig");
        show_image(crop, "crop");
        cvWaitKey(0);
        */
        //grayscale_image_3c(crop);
        free_image(im);
        X.vals[i] = crop.data;
        X.cols = crop.h*crop.w*crop.c;
    }
    return X;
}

float **get_iris_data(int n, int m)
{
    float **iris_data = calloc(n, sizeof(float*));
    int i;
    for (i = 0; i < n; i++) {
        int index = rand() % m;
        iris_data[i] = IRIS_DATA[index];
    }
    return iris_data;
};

int *get_iris_data_indices(int n, int m)
{
    int *indices = calloc(n, sizeof(int));
    int i;
    for (i = 0; i < n; i++) {
        int index = rand() % m;
        indices[i] = index;
    }
    return indices;
}

matrix load_iris_labels(int *indices, int n, int k)
{
    matrix y = make_matrix(n, k);
    int i;
    int j;
    int label;
    for(i = 0; i < n; ++i) {
        memset(y.vals[i], 0, k * sizeof(float));
        j = indices[i];
        label = IRIS_DATA_LABELS[j];
        y.vals[i][label] = 1;
    }
    return y;
}

data load_iris_data()
{
    // TODO パラメータを引数に取るようにする
    /*
    if(a.exposure == 0) a.exposure = 1;
    if(a.saturation == 0) a.saturation = 1;
    if(a.aspect == 0) a.aspect = 1;
     */
    // char **paths = NULL;
    // int n = 64;
    // int n = 8;
    int n = 1;
    int m = 75;
    int k = 3;
    // tree *hierarchy = NULL;
    // int min = 32;
    int min = 4;
    // int max = 32;
    int max = 4;
    // int size = 28;
    int size = 4;
    float angle = 0;
    float aspect = 1;
    float hue = 0.1;
    float saturation = 0.75;
    float exposure = 0.75;
    int center = 0;
    int *indices = get_iris_data_indices(n, m);

    // data *d = malloc(sizeof(data));
    data d;
    d.shallow = 0;
    d.w=size;
    d.h=size;
    d.X = load_iris_images(indices, n, min, max, size, angle, aspect, hue, saturation, exposure, center);
    d.y = load_iris_labels(indices, n, k);

    free(indices);
    return d;
};

void forward_hidden_layer(network *net, data d) {
    // assert(d.X.rows % net->batch == 0);
    int batch = net->batch;
    int n = d.X.rows / batch;

    int i;
    for(i = 0; i < n; ++i){
        get_next_batch(d, batch, i*batch, net->input, net->truth);
        // train_network_datum(net);
        *net->seen += net->batch;
        net->train = 1;
        forward_network(net);
    }
}

void test_mlp_hidden_layer_forward() {
    list *sections = make_cfg();
    printf("started making MLP network.\n");
    network *net = make_mlp_single_network(sections);
    printf("finished making MLP network.\n");

    data train;
    printf("started loading data.\n");
    train = load_iris_data();
    printf("finished loading data.\n");

    printf("started forward test.\n");
    forward_hidden_layer(net, train);
    printf("finished forward test.\n");

    // print output

    free_list(sections);
    free_network(net);
}

void train_iris_classifier()
{
    int N = 75;
    list *sections = make_cfg();
    printf("started making MLP network.");
    network *net = make_mlp_single_network(sections);
    printf("finished making MLP network.");

    float avg_loss = -1;
    data train;
    while(get_current_batch(net) < net->max_batches || net->max_batches == 0) {
        printf("started loading data.");
        train = load_iris_data();
        printf("finished loading data.");

        printf("started training.");
        float loss = train_network(net, train);
        printf("finished training.");

        if(avg_loss == -1) avg_loss = loss;
        avg_loss = avg_loss*.9 + loss*.1;
        printf("%ld, %.3f: %f, %f avg, %f rate, %ld images\n", get_current_batch(net), (float)(*net->seen)/N, loss, avg_loss, get_current_rate(net), *net->seen);
    }

    free_list(sections);
    free_network(net);
}